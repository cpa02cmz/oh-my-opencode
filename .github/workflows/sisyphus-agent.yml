name: Sisyphus Agent

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Custom prompt"
        required: false
      pr_number:
        description: "PR number (optional)"
        required: false
        type: string
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, ready_for_review, review_requested, reopened]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

jobs:
  agent:
    runs-on: ubuntu-latest
    # Concurrency: one run per PR/issue at a time
    concurrency:
      group: sisyphus-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
      cancel-in-progress: true

    # Trigger conditions (MAINTAINERS ONLY for all events):
    # 1. workflow_dispatch (manual) - any actor with workflow access
    # 2. pull_request events - only if PR author is maintainer
    # 3. @sisyphus-dev-ai mention - only from maintainers
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft != true &&
       contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association) &&
       (github.event.action == 'opened' ||
        github.event.action == 'ready_for_review' ||
        github.event.action == 'reopened' ||
        (github.event.action == 'review_requested' && github.event.requested_reviewer.login == 'sisyphus-dev-ai'))) ||
      (contains(github.event.comment.body || github.event.review.body, '@sisyphus-dev-ai') &&
       (github.event.comment.user.login || github.event.review.user.login) != 'sisyphus-dev-ai' &&
       contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || github.event.review.author_association))

    # Minimal default GITHUB_TOKEN permissions
    permissions:
      contents: read

    steps:
      # Checkout with sisyphus-dev-ai's PAT
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # Git config - commits as sisyphus-dev-ai
      - name: Configure Git as sisyphus-dev-ai
        run: |
          git config user.name "sisyphus-dev-ai"
          git config user.email "sisyphus-dev-ai@users.noreply.github.com"

      # gh CLI auth as sisyphus-dev-ai
      - name: Authenticate gh CLI as sisyphus-dev-ai
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          gh auth status

      - name: Ensure tmux is available (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          if ! command -v tmux >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends tmux
          fi
          tmux -V

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # Install OpenCode + oh-my-opencode + auth in single step
      - name: Setup OpenCode with oh-my-opencode
        env:
          OPENCODE_AUTH_JSON: ${{ secrets.OPENCODE_AUTH_JSON }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"

          # Install OpenCode (skip if cached)
          if ! command -v opencode &>/dev/null; then
            for i in 1 2 3; do
              echo "Attempt $i: Installing OpenCode..."
              curl -fsSL https://opencode.ai/install -o /tmp/opencode-install.sh
              if file /tmp/opencode-install.sh | grep -q "shell script\|text"; then
                bash /tmp/opencode-install.sh && break
              fi
              echo "Download corrupted, retrying in 5s..."
              sleep 5
            done
          fi
          opencode --version

          bunx oh-my-opencode install --no-tui --claude=max20 --chatgpt=no --gemini=no

          OPENCODE_JSON=~/.config/opencode/opencode.json
          jq --arg baseURL "$ANTHROPIC_BASE_URL" --arg apiKey "$ANTHROPIC_API_KEY" '
            .provider.anthropic = {
              "name": "Anthropic",
              "npm": "@ai-sdk/anthropic",
              "options": {
                "baseURL": $baseURL,
                "apiKey": $apiKey
              },
              "models": {
                "claude-opus-4-5": {
                  "id": "claude-opus-4-5-20251101",
                  "name": "Opus 4.5",
                  "limit": { "context": 200000, "output": 64000 },
                  "options": { "effort": "high" }
                },
                "claude-opus-4-5-high": {
                  "id": "claude-opus-4-5-20251101",
                  "name": "Opus 4.5 High",
                  "limit": { "context": 200000, "output": 128000 },
                  "options": { "effort": "high", "thinking": { "type": "enabled", "budgetTokens": 64000 } }
                },
                "claude-sonnet-4-5": {
                  "id": "claude-sonnet-4-5-20250929",
                  "name": "Sonnet 4.5",
                  "limit": { "context": 200000, "output": 64000 }
                },
                "claude-sonnet-4-5-high": {
                  "id": "claude-sonnet-4-5-20250929",
                  "name": "Sonnet 4.5 High",
                  "limit": { "context": 200000, "output": 128000 },
                  "options": { "thinking": { "type": "enabled", "budgetTokens": 64000 } }
                },
                "claude-haiku-4-5": {
                  "id": "claude-haiku-4-5-20251001",
                  "name": "Haiku 4.5",
                  "limit": { "context": 200000, "output": 64000 }
                }
              }
            }
          ' "$OPENCODE_JSON" > /tmp/oc.json && mv /tmp/oc.json "$OPENCODE_JSON"

          OMO_JSON=~/.config/opencode/oh-my-opencode.json
          PROMPT_APPEND=$(cat << 'PROMPT_EOF'

          ## GitHub Actions Environment

          You are `sisyphus-dev-ai` in GitHub Actions.

          ### CRITICAL: GitHub Comments = Your ONLY Output

          User CANNOT see console. Post everything via `gh issue comment` or `gh pr comment`.

          ### Comment Formatting (CRITICAL)

          **ALWAYS use heredoc syntax for comments containing code references, backticks, or multiline content:**

          ```bash
          gh issue comment <number> --body "$(cat <<'EOF'
          Your comment with `backticks` and code references preserved here.
          Multiple lines work perfectly.
          EOF
          )"
          ```

          **NEVER use direct quotes with backticks** (shell will interpret them as command substitution):
          ```bash
          # WRONG - backticks disappear:
          gh issue comment 123 --body "text with `code`"
          
          # CORRECT - backticks preserved:
          gh issue comment 123 --body "$(cat <<'EOF'
          text with `code`
          EOF
          )"
          ```

          ### Rules
          - EVERY response = GitHub comment (use heredoc for proper escaping)
          - Code changes = PR (never push main/master)
          - Setup: bun install first
          - Acknowledge immediately, report when done

          ### Git Config
          - user.name: sisyphus-dev-ai
          - user.email: sisyphus-dev-ai@users.noreply.github.com
          PROMPT_EOF
          )
          jq --arg append "$PROMPT_APPEND" '.agents.Sisyphus.prompt_append = $append' "$OMO_JSON" > /tmp/omo.json && mv /tmp/omo.json "$OMO_JSON"

          mkdir -p ~/.local/share/opencode
          echo "$OPENCODE_AUTH_JSON" > ~/.local/share/opencode/auth.json
          chmod 600 ~/.local/share/opencode/auth.json

          cat "$OPENCODE_JSON"

      - name: Check Recent Reviews
        id: recent_review
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REVIEWS=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUM}/reviews" \
            --jq '[.[] | select(.user.login == "sisyphus-dev-ai" and (.submitted_at | fromdateiso8601) > (now - 600))] | length' 2>/dev/null || echo "0")
          
          if [[ "$REVIEWS" -gt 0 ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "ðŸš« Sisyphus already reviewed this PR in the last 10 minutes"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Collect Context
        id: context
        if: steps.recent_review.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          EVENT="${{ github.event_name }}"

          if [[ "$EVENT" == "pull_request" ]]; then
            echo "mode=review" >> $GITHUB_OUTPUT
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "action=${{ github.event.action }}" >> $GITHUB_OUTPUT
            AUTHOR="${{ github.event.pull_request.user.login }}"
            
            if [[ "${{ github.event.action }}" == "review_requested" ]]; then
              REQUESTED_BY="${{ github.event.sender.login }}"
              echo "requested_by=$REQUESTED_BY" >> $GITHUB_OUTPUT
            fi
            COMMENT=""
            COMMENT_ID=""
          elif [[ "$EVENT" == "issue_comment" ]]; then
            echo "mode=agent" >> $GITHUB_OUTPUT
            ISSUE_NUM="${{ github.event.issue.number }}"
            COMMENT="${{ github.event.comment.body }}"
            AUTHOR="${{ github.event.comment.user.login }}"
            COMMENT_ID="${{ github.event.comment.id }}"

            if gh api "repos/${{ github.repository }}/issues/${ISSUE_NUM}" | jq -e '.pull_request' > /dev/null; then
              echo "type=pr" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            else
              echo "type=issue" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            fi
          elif [[ "$EVENT" == "pull_request_review_comment" ]]; then
            echo "mode=agent" >> $GITHUB_OUTPUT
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            COMMENT="${{ github.event.comment.body }}"
            AUTHOR="${{ github.event.comment.user.login }}"
            COMMENT_ID="${{ github.event.comment.id }}"
          elif [[ "$EVENT" == "pull_request_review" ]]; then
            echo "mode=agent" >> $GITHUB_OUTPUT
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            COMMENT="${{ github.event.review.body }}"
            AUTHOR="${{ github.event.review.user.login }}"
            COMMENT_ID=""
          elif [[ "$EVENT" == "workflow_dispatch" ]]; then
            echo "mode=agent" >> $GITHUB_OUTPUT
            if [[ -n "${{ inputs.pr_number }}" ]]; then
              echo "type=pr" >> $GITHUB_OUTPUT
              echo "number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            fi
            AUTHOR="${{ github.actor }}"
            COMMENT="${{ inputs.prompt }}"
            COMMENT_ID=""
          fi

          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT

      - name: Collect PR Context for Review
        id: pr_context
        if: steps.context.outputs.mode == 'review' && steps.recent_review.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.context.outputs.number }}"
          
          CHANGED_FILES=$(gh pr view "$PR_NUM" --json files --jq '.files[].path' | head -30)
          echo "files<<FILES_EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "FILES_EOF" >> $GITHUB_OUTPUT
          
          FILES_COUNT=$(gh pr view "$PR_NUM" --json files --jq '.files | length')
          echo "files_count=$FILES_COUNT" >> $GITHUB_OUTPUT
          
          DIFF=$(gh pr diff "$PR_NUM" 2>/dev/null | head -c 40000 || echo "")
          echo "diff<<DIFF_EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "DIFF_EOF" >> $GITHUB_OUTPUT
          
          UNRESOLVED=$(gh api graphql -f query='
          query($owner: String!, $repo: String!, $pr: Int!) {
            repository(owner: $owner, name: $repo) {
              pullRequest(number: $pr) {
                reviewThreads(first: 30) {
                  nodes {
                    isResolved
                    path
                    line
                    comments(first: 3) {
                      nodes { author { login } body }
                    }
                  }
                }
              }
            }
          }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" -F pr="$PR_NUM" \
            --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)]' 2>/dev/null || echo "[]")
          
          UNRESOLVED_COUNT=$(echo "$UNRESOLVED" | jq 'length' 2>/dev/null || echo "0")
          echo "unresolved_count=$UNRESOLVED_COUNT" >> $GITHUB_OUTPUT
          
          echo "unresolved_threads<<THREADS_EOF" >> $GITHUB_OUTPUT
          echo "$UNRESOLVED" | jq -c '.' >> $GITHUB_OUTPUT
          echo "THREADS_EOF" >> $GITHUB_OUTPUT

      - name: Add eyes reaction
        if: steps.context.outputs.comment_id != '' && steps.recent_review.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            -X POST -f content="eyes" || true

      - name: Add working label
        if: steps.context.outputs.number != '' && steps.recent_review.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh label create "sisyphus: working" \
            --repo "${{ github.repository }}" \
            --color "fcf2e1" \
            --description "Sisyphus is currently working on this" \
            --force || true
          
          if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
            gh pr edit "${{ steps.context.outputs.number }}" \
              --repo "${{ github.repository }}" \
              --add-label "sisyphus: working" || true
          else
            gh issue edit "${{ steps.context.outputs.number }}" \
              --repo "${{ github.repository }}" \
              --add-label "sisyphus: working" || true
          fi

      - name: Run OpenCode
        if: steps.recent_review.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"

          MODE="${{ steps.context.outputs.mode }}"
          
          if [[ "$MODE" == "review" ]]; then
            PROMPT="
          Your username is @sisyphus-dev-ai. You've been requested to review PR #${{ steps.context.outputs.number }}.

          ## Review Context
          - Repository: ${{ github.repository }}
          - PR Title: ${{ github.event.pull_request.title }}
          - Author: @${{ github.event.pull_request.user.login }}
          - Trigger: ${{ steps.context.outputs.action }}
          - Requested by: @${{ steps.context.outputs.requested_by }}
          - Default Branch: ${{ github.event.repository.default_branch }}
          - Changed Files: ${{ steps.pr_context.outputs.files_count }}
          - Unresolved Threads: ${{ steps.pr_context.outputs.unresolved_count }}

          ## Changed Files (first 30)
          \`\`\`
          ${{ steps.pr_context.outputs.files }}
          \`\`\`

          ## Unresolved Review Threads
          ${{ steps.pr_context.outputs.unresolved_threads }}

          ## PR Diff (truncated to 40KB)
          \`\`\`diff
          ${{ steps.pr_context.outputs.diff }}
          \`\`\`

          ---

          ## Review Instructions

          1. **Analyze** the PR changes thoroughly using todo tools
          2. **Check** for:
             - Bugs or potential issues
             - Type safety (no \`as any\`, \`@ts-ignore\`)
             - Following existing codebase patterns
             - Test coverage if applicable
          3. **Address** any unresolved threads from previous reviews
          4. **Submit** your review using heredoc:
             \`\`\`bash
             gh pr review ${{ steps.context.outputs.number }} --comment --body \"\$(cat <<'EOF'
             ## ðŸ” Sisyphus Code Review
             
             ### Summary
             [Your concise summary]
             
             ### Issues Found
             [List any issues with severity: CRITICAL/WARNING/SUGGESTION]
             
             ### Verdict
             [APPROVE/REQUEST_CHANGES/COMMENT with reason]
             EOF
             )\"
             \`\`\`

          Use \`--approve\` for approval, \`--request-changes\` if changes needed.
          Be concise. Focus on issues, not praise. Follow oh-my-opencode conventions (bun, TypeScript, kebab-case dirs)."
          else
            PROMPT="
          Your username is @sisyphus-dev-ai, mentioned by @${{ steps.context.outputs.author }} in ${{ github.repository }}.

          ## Context
          - Type: ${{ steps.context.outputs.type }}
          - Number: #${{ steps.context.outputs.number }}
          - Repository: ${{ github.repository }}
          - Default Branch: ${{ github.event.repository.default_branch }}

          ## User's Request
          ${{ steps.context.outputs.comment }}

          ---

          First, acknowledge with \`gh issue comment ${{ steps.context.outputs.number }} --body \"ðŸ‘‹ Hey @${{ steps.context.outputs.author }}! I'm on it...\"\`

          Then write everything using the todo tools.
          Then investigate and satisfy the request. Only if user requested to you to work explicitly, then use plan agent to plan, todo obsessively then create a PR to \`${{ github.event.repository.default_branch }}\` branch."
          fi

          opencode run "$PROMPT"

      # Push changes (as sisyphus-dev-ai)
      - name: Push changes
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git add -A
            git commit -m "chore: changes by sisyphus-dev-ai" || true
          fi

          BRANCH=$(git branch --show-current)
          if [[ "$BRANCH" != "main" && "$BRANCH" != "master" ]]; then
            git push origin "$BRANCH" || true
          fi

      - name: Update reaction and remove label
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ -n "${{ steps.context.outputs.comment_id }}" ]]; then
            REACTION_ID=$(gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              --jq '.[] | select(.content == "eyes" and .user.login == "sisyphus-dev-ai") | .id' | head -1)
            if [[ -n "$REACTION_ID" ]]; then
              gh api -X DELETE "/repos/${{ github.repository }}/reactions/${REACTION_ID}" || true
            fi

            gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              -X POST -f content="+1" || true
          fi

          if [[ -n "${{ steps.context.outputs.number }}" ]]; then
            if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
              gh pr edit "${{ steps.context.outputs.number }}" \
                --repo "${{ github.repository }}" \
                --remove-label "sisyphus: working" || true
            else
              gh issue edit "${{ steps.context.outputs.number }}" \
                --repo "${{ github.repository }}" \
                --remove-label "sisyphus: working" || true
            fi
          fi
